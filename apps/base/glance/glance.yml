# Glance Dashboard Configuration
# Configured for: glance.sarma.love (VPN-only access)

server:
  assets-path: /app/assets

# Theme: Gruvbox Dark
theme:
  light: false
  custom-css-file: /assets/glance-gruvbox.css

# Dashboard Pages
pages:
  - name: Home
    columns:
      # Column 1: Left sidebar (small)
      - size: small
        widgets:
          - type: calendar
            max-events: 15
            cache: 1h

          - type: twitch-channels
            channels:
              - forsen
              - northernlion
              - k3soju
            collapse-after: 3
            sort-by: live
            cache: 5m

      # Column 2: Main content (full width)
      - size: full
        widgets:
          - type: monitor
            cache: 1m
            title: Services
            sites:
              - title: Linkding
                url: https://linkding.sarma.love
                check-url: http://linkding.linkding.svc.cluster.local:9090
                icon: si:linkding

          - type: split-column
            widgets:
              - type: monitor
                collapse-after: 10
                cache: 1m
                title: Networking
                sites:
                  - title: Headplane
                    url: https://headplane.sarma.love/admin
                    check-url: http://headplane.headscale.svc.cluster.local:3000/admin
                    icon: si:tailscale
                  - title: Traefik
                    url: https://traefik.sarma.love
                    check-url: http://traefik-api.traefik.svc.cluster.local:9000/api/overview
                    icon: si:traefikproxy
              - type: monitor
                collapse-after: 10
                cache: 1m
                title: Monitoring
                sites:
                  - title: Grafana
                    url: https://grafana.sarma.love
                    check-url: http://monitoring-kube-prometheus-stack-grafana.monitoring.svc.cluster.local
                    icon: si:grafana
                  - title: Prometheus
                    url: https://prometheus.sarma.love
                    check-url: http://monitoring-kube-prometheus-prometheus.monitoring.svc.cluster.local:9090
                    icon: si:prometheus

          - type: monitor
            collapse-after: 10
            cache: 1m
            title: Infrastructure
            sites:
              - title: Longhorn
                url: https://longhorn.sarma.love
                check-url: http://longhorn-frontend.longhorn-system.svc.cluster.local
                icon: si:kubernetes
              - title: Vaultwarden
                url: https://vault.sarma.love
                check-url: http://vaultwarden-vaultwarden.vaultwarden.svc.cluster.local
                icon: si:bitwarden

      # Column 3: Right sidebar (small)
      - size: small
        widgets:
          - type: weather
            location: Belgrade, Serbia
            units: metric
            hour-format: 24h
            hide-location: false
            show-area-name: true
            cache: 30m

          - type: custom-api
            title: Headscale Nodes
            title-url: https://headplane.sarma.love/admin
            url: https://headscale.sarma.love/api/v1/node
            cache: 30s
            headers:
              Authorization: Bearer ${HEADSCALE_API_KEY}
            template: |
              {{/* Headscale Nodes Widget - Adapted from Tailscale widget */}}
              {{/* CSS source: widgets/headscale-nodes/style.css */}}
              {{/* Set to true if you'd like an indicator for online devices */}}
              {{ $enableOnlineIndicator := true }}

              <style>
              .device-info-container {
                position: relative;
                overflow: hidden;
                height: 1.5em;
              }
              .device-info {
                display: flex;
                transition: transform 0.2s ease, opacity 0.2s ease;
              }
              .device-ip {
                position: absolute;
                top: 0;
                left: 0;
                transform: translateY(-100%);
                opacity: 0;
                transition: transform 0.2s ease, opacity 0.2s ease;
              }
              .device-info-container:hover .device-info {
                transform: translateY(100%);
                opacity: 0;
              }
              .device-info-container:hover .device-ip {
                transform: translateY(0);
                opacity: 1;
              }
              .router-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: var(--color-blue-light);
                display: inline-block;
                margin-left: 4px;
                vertical-align: middle;
              }
              .offline-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: var(--color-negative);
                display: inline-block;
                margin-left: 4px;
                vertical-align: middle;
              }
              .online-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: var(--color-positive);
                display: inline-block;
                margin-left: 4px;
                vertical-align: middle;
              }
              .device-name-container {
                display: flex;
                align-items: center;
                gap: 8px;
              }
              .indicators-container {
                display: flex;
                align-items: center;
                gap: 4px;
              }
              .tag-badge {
                background-color: var(--color-primary-dark);
                color: var(--color-text-base);
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 0.75em;
                font-weight: 500;
              }
              </style>

              <ul class="list list-gap-10 collapsible-container" data-collapse-after="4">
                {{ range .JSON.Array "nodes" }}
                <li>
                  <div class="flex items-center gap-10">
                    <div class="device-name-container grow">
                      <span class="size-h4 block text-truncate color-primary">
                        {{ .String "givenName" }}
                      </span>
                      <div class="indicators-container">
                        {{ $online := .Bool "online" }}
                        {{ if $online }}
                          {{ if $enableOnlineIndicator }}
                          <span class="online-indicator" data-popover-type="text" data-popover-text="Online"></span>
                          {{ end }}
                        {{ else }}
                          {{ $lastSeen := .String "lastSeen" | parseTime "rfc3339" }}
                          {{ $lastSeenTimezoned := $lastSeen.In now.Location }}
                          <span class="offline-indicator" data-popover-type="text"
                            data-popover-text="Offline - Last seen {{ $lastSeenTimezoned.Format "Jan 2 3:04pm" }}"></span>
                        {{ end }}

                        {{/* Show router indicator if node has approved routes */}}
                        {{ $routes := .Array "approvedRoutes" }}
                        {{ if gt (len $routes) 0 }}
                        <span class="router-indicator" data-popover-type="text"
                          data-popover-text="Router - {{ range $i, $route := $routes }}{{ if $i }}, {{ end }}{{ $route }}{{ end }}"></span>
                        {{ end }}
                      </div>
                    </div>
                    {{/* Show tags if present */}}
                    {{ $tags := .Array "validTags" }}
                    {{ if gt (len $tags) 0 }}
                    <div class="flex gap-5">
                      {{ range $tags }}
                      {{ $tagValue := .Str }}
                      <span class="tag-badge">{{ $tagValue | trimPrefix "tag:" }}</span>
                      {{ end }}
                    </div>
                    {{ end }}
                  </div>
                  <div class="device-info-container">
                    <ul class="list-horizontal-text device-info">
                      <li>{{ .String "user.name" }}</li>
                    </ul>
                    <div class="device-ip">
                      {{ .String "ipAddresses.0" }}
                    </div>
                  </div>
                </li>
                {{ end }}
              </ul>

          - type: extension
            url: http://glance-k8s-glance-k8s.glance-k8s.svc.cluster.local/extension/nodes
            allow-potentially-dangerous-html: true
            cache: 10s

  - name: Media
    columns:
      - size: full
        widgets:
          - type: split-column
            widgets:
              - type: monitor
                cache: 1m
                title: Download & Indexing
                sites:
                  - title: qBittorrent
                    url: https://qbittorrent.sarma.love
                    check-url: http://qbittorrent.media.svc.cluster.local:8080
                    icon: si:qbittorrent
                  - title: Prowlarr
                    url: https://prowlarr.sarma.love
                    check-url: http://prowlarr.media.svc.cluster.local:9696
                    icon: mdi:download-network

              - type: monitor
                cache: 1m
                title: Streaming & Requests
                sites:
                  - title: Jellyfin
                    url: https://jellyfin.sarma.love
                    check-url: http://jellyfin.media.svc.cluster.local:8096
                    icon: si:jellyfin
                  - title: Jellyseerr
                    url: https://jellyseerr.sarma.love
                    check-url: http://jellyseerr.media.svc.cluster.local:5055
                    icon: si:jellyfin

      - size: full
        widgets:
          - type: split-column
            widgets:
              - type: monitor
                cache: 1m
                title: Automation
                sites:
                  - title: Sonarr
                    url: https://sonarr.sarma.love
                    check-url: http://sonarr.media.svc.cluster.local:8989
                    icon: si:sonarr
                  - title: Radarr
                    url: https://radarr.sarma.love
                    check-url: http://radarr.media.svc.cluster.local:7878
                    icon: si:radarr
                  - title: Bazarr
                    url: https://bazarr.sarma.love
                    check-url: http://bazarr.media.svc.cluster.local:6767
                    icon: mdi:closed-caption

              - type: monitor
                cache: 1m
                title: Monitoring
                sites:
                  - title: Jellystat
                    url: https://jellystat.sarma.love
                    check-url: http://jellystat.media.svc.cluster.local:3000
                    icon: mdi:chart-line

          # Jellyfin Library Stats
          - type: custom-api
            title: "Jellyfin Stats"
            title-url: https://jellyfin.sarma.love
            cache: 1h
            base-url: http://jellyfin:8096
            options:
              url: http://jellyfin:8096
              key: ${JELLYFIN_API_KEY}
            template: |
              {{ $url := .Options.StringOr "url" "" }}
              {{ $key := .Options.StringOr "key" "" }}

              {{- if or (eq $url "") (eq $key "") -}}

                <p>Error: The URL or API Key was not configured in the widget options.</p>

              {{- else -}}

                {{- $requestUrl := printf "%s/emby/Items/Counts?api_key=%s" $url $key -}}
                {{- $jellyfinData := newRequest $requestUrl | getResponse -}}

                {{- if eq $jellyfinData.Response.StatusCode 200 -}}
                  <div class="flex flex-column gap-5">
                    <div class="flex justify-between text-center">

                      <div>
                        <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "MovieCount" | formatNumber }}</div>
                        <div class="size-h5 uppercase">Movies</div>
                      </div>

                      <div>
                        <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "SeriesCount" | formatNumber }}</div>
                        <div class="size-h5 uppercase">TV Shows</div>
                      </div>

                      <div>
                        <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "EpisodeCount" | formatNumber }}</div>
                        <div class="size-h5 uppercase">Episodes</div>
                      </div>

                      <div>
                        <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "SongCount" | formatNumber }}</div>
                        <div class="size-h5 uppercase">Songs</div>
                      </div>

                    </div>
                  </div>
                {{- else -}}
                  <p>Failed: {{ $jellyfinData.Response.Status }}</p>
                {{- end -}}
              {{- end -}}

          # Jellyseerr Request Stats (Overseerr-compatible)
          - type: custom-api
            title: Jellyseerr Requests
            title-url: https://jellyseerr.sarma.love/requests
            url: http://jellyseerr:5055/api/v1/request/count
            cache: 1h
            options:
              small-column: false
              compact: true
            headers:
              accept: "application/json"
              x-api-key: ${JELLYSEERR_API_KEY}
            template: |
              {{ $isSmallColumn := .Options.BoolOr "small-column" false }}
              {{ $isCompact := .Options.BoolOr "compact" false }}

              {{ if eq .Response.StatusCode 200 }}
                {{ if $isSmallColumn }}
                  <ul class="list list-gap-10 collapsible-container" data-collapse-after="3">
                    <li class="flex items-start gap-10">
                      <div class="flex-1 size-h3 {{ if $isCompact }}size-h5{{ end }}">Total</div>
                      <div class="flex-1 color-highlight shrink-0 text-right size-h3 {{ if $isCompact }}size-h5{{ end }}">
                        {{ .JSON.Int "total" | formatNumber }}
                      </div>
                    </li>
                    <li class="flex items-start gap-10">
                      <div class="flex-1 size-h3 {{ if $isCompact }}size-h5{{ end }}">Movies</div>
                      <div class="flex-1 color-highlight shrink-0 text-right size-h3 {{ if $isCompact }}size-h5{{ end }}">
                        {{ .JSON.Int "movie" | formatNumber }}
                      </div>
                    </li>
                    <li class="flex items-start gap-10">
                      <div class="flex-1 size-h3 {{ if $isCompact }}size-h5{{ end }}">TV Series</div>
                      <div class="flex-1 color-highlight shrink-0 text-right size-h3 {{ if $isCompact }}size-h5{{ end }}">
                        {{ .JSON.Int "tv" | formatNumber }}
                      </div>
                    </li>
                    <li class="flex items-start gap-10">
                      <div class="flex-1 size-h3 {{ if $isCompact }}size-h5{{ end }}">Pending</div>
                      <div class="flex-1 color-highlight shrink-0 text-right size-h3 {{ if $isCompact }}size-h5{{ end }}">
                        {{ .JSON.Int "pending" | formatNumber }}
                      </div>
                    </li>
                    <li class="flex items-start gap-10">
                      <div class="flex-1 size-h3 {{ if $isCompact }}size-h5{{ end }}">Approved</div>
                      <div class="flex-1 color-highlight shrink-0 text-right size-h3 {{ if $isCompact }}size-h5{{ end }}">
                        {{ .JSON.Int "approved" | formatNumber }}
                      </div>
                    </li>
                    <li class="flex items-start gap-10">
                      <div class="flex-1 size-h3 {{ if $isCompact }}size-h5{{ end }}">Declined</div>
                      <div class="flex-1 color-highlight shrink-0 text-right size-h3 {{ if $isCompact }}size-h5{{ end }}">
                        {{ .JSON.Int "declined" | formatNumber }}
                      </div>
                    </li>
                    <li class="flex items-start gap-10">
                      <div class="flex-1 size-h3 {{ if $isCompact }}size-h5{{ end }}">Processing</div>
                      <div class="flex-1 color-highlight shrink-0 text-right size-h3 {{ if $isCompact }}size-h5{{ end }}">
                        {{ .JSON.Int "processing" | formatNumber }}
                      </div>
                    </li>
                    <li class="flex items-start gap-10">
                      <div class="flex-1 size-h3 {{ if $isCompact }}size-h5{{ end }}">Available</div>
                      <div class="flex-1 color-highlight shrink-0 text-right size-h3 {{ if $isCompact }}size-h5{{ end }}">
                        {{ .JSON.Int "available" | formatNumber }}
                      </div>
                    </li>
                  </ul>
                {{ else }}
                  <div class="flex justify-evenly text-center">
                    <div>
                        <div class="color-highlight size-h1 {{ if $isCompact }}size-h3{{ end }}">{{ .JSON.Int "total" | formatNumber }}</div>
                        <div class="size-h3 {{ if $isCompact }}size-h5{{ end }}">Total</div>
                    </div>
                    <div>
                        <div class="color-highlight size-h1 {{ if $isCompact }}size-h3{{ end }}">{{ .JSON.Int "movie" | formatNumber }}</div>
                        <div class="size-h3 {{ if $isCompact }}size-h5{{ end }}">Movies</div>
                    </div>
                    <div>
                        <div class="color-highlight size-h1 {{ if $isCompact }}size-h3{{ end }}">{{ .JSON.Int "tv" | formatNumber }}</div>
                        <div class="size-h3 {{ if $isCompact }}size-h5{{ end }}">TV Series</div>
                    </div>
                  {{ if not $isCompact }}
                    </div>
                    <div class="flex justify-evenly text-center margin-top-20">
                  {{ end }}
                    <div>
                        <div class="color-highlight size-h1 {{ if $isCompact }}size-h3{{ end }}">{{ .JSON.Int "pending" | formatNumber }}</div>
                        <div class="size-h3 {{ if $isCompact }}size-h5{{ end }}">Pending</div>
                    </div>
                    <div>
                        <div class="color-highlight size-h1 {{ if $isCompact }}size-h3{{ end }}">{{ .JSON.Int "approved" | formatNumber }}</div>
                        <div class="size-h3 {{ if $isCompact }}size-h5{{ end }}">Approved</div>
                    </div>
                    <div>
                        <div class="color-highlight size-h1 {{ if $isCompact }}size-h3{{ end }}">{{ .JSON.Int "declined" | formatNumber }}</div>
                        <div class="size-h3 {{ if $isCompact }}size-h5{{ end }}">Declined</div>
                    </div>
                    <div>
                        <div class="color-highlight size-h1 {{ if $isCompact }}size-h3{{ end }}">{{ .JSON.Int "processing" | formatNumber }}</div>
                        <div class="size-h3 {{ if $isCompact }}size-h5{{ end }}">Processing</div>
                    </div>
                    <div>
                        <div class="color-highlight size-h1 {{ if $isCompact }}size-h3{{ end }}">{{ .JSON.Int "available" | formatNumber }}</div>
                        <div class="size-h3 {{ if $isCompact }}size-h5{{ end }}">Available</div>
                    </div>
                  </div>
                {{ end }}
              {{ end }}

          # qBittorrent Stats
          - type: custom-api
            title: qBittorrent
            title-url: https://qbittorrent.sarma.love
            cache: 10s
            options:
              view: "basic"
              mode: "default"
            subrequests:
              transfer:
                url: http://qbittorrent:8080/api/v2/transfer/info
              seeding:
                url: http://qbittorrent:8080/api/v2/torrents/info
                parameters:
                  filter: seeding
              leeching:
                url: http://qbittorrent:8080/api/v2/torrents/info
                parameters:
                  filter: downloading
            template: |
              {{ $transfer := .Subrequest "transfer" }}
              {{ $seeding := .Subrequest "seeding" }}
              {{ $leeching := .Subrequest "leeching" }}

              {{ if and (eq $transfer.Response.StatusCode 200) (eq $seeding.Response.StatusCode 200) (eq $leeching.Response.StatusCode 200) }}
                {{ $isDetailed := eq (.Options.StringOr "view" "basic") "detailed" }}
                {{ $mode := .Options.StringOr "mode" "default" }}

                <!-- Basic View -->
                <div class="flex justify-between text-center">
                  <div>
                    {{ $dlSpeed := $transfer.JSON.Float "dl_info_speed" }}
                    <div class="color-highlight size-h3">{{ printf "%.1f MB/s" (div $dlSpeed 1000000.0) }}</div>
                    <div class="size-h6">DOWNLOADING</div>
                  </div>
                  {{ if eq $mode "upload" }}
                  <div>
                    {{ $ulSpeed := $transfer.JSON.Float "up_info_speed" }}
                    <div class="color-highlight size-h3">{{ printf "%.1f MB/s" (div $ulSpeed 1000000.0) }}</div>
                    <div class="size-h6">UPLOADING</div>
                  </div>
                  {{ end }}
                  <div>
                    <div class="color-highlight size-h3">{{ len ($seeding.JSON.Array "") }}</div>
                    <div class="size-h6">SEEDING</div>
                  </div>
                  {{ if eq $mode "default" }}
                  <div>
                    <div class="color-highlight size-h3">{{ len ($leeching.JSON.Array "") }}</div>
                    <div class="size-h6">LEECHING</div>
                  </div>
                  {{ end }}
                </div>
              {{ else }}
                <div class="color-negative text-center">
                  <p>Error fetching qBittorrent data.</p>
                  <p class="size-sm">Check URL and authentication bypass settings.</p>
                </div>
              {{ end }}
