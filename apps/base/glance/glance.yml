# Glance Dashboard Configuration
# Configured for: glance.sarma.love (VPN-only access)

server:
  assets-path: /app/assets

# Theme: Gruvbox Dark
theme:
  light: false
  custom-css-file: /assets/glance-gruvbox.css

# Dashboard Pages
pages:
  - name: Home
    columns:
      # Column 1: Left sidebar (small)
      - size: small
        widgets:
          - type: calendar
            max-events: 15
            cache: 1h

          - type: twitch-channels
            channels:
              - forsen
              - northernlion
              - k3soju
            collapse-after: 3
            sort-by: live
            cache: 5m

      # Column 2: Main content (full width)
      - size: full
        widgets:
          - type: monitor
            cache: 1m
            title: Services
            sites:
              - title: Linkding
                url: https://linkding.sarma.love
                check-url: http://linkding.linkding.svc.cluster.local:9090
                icon: si:linkding

          - type: split-column
            widgets:
              - type: monitor
                collapse-after: 10
                cache: 1m
                title: Networking
                sites:
                  - title: Headplane
                    url: https://headplane.sarma.love/admin
                    check-url: http://headplane.headscale.svc.cluster.local:3000/admin
                    icon: si:tailscale
                  - title: Traefik
                    url: https://traefik.sarma.love
                    check-url: http://traefik-api.traefik.svc.cluster.local:9000/api/overview
                    icon: si:traefikproxy
              - type: monitor
                collapse-after: 10
                cache: 1m
                title: Monitoring
                sites:
                  - title: Grafana
                    url: https://grafana.sarma.love
                    check-url: http://monitoring-kube-prometheus-stack-grafana.monitoring.svc.cluster.local
                    icon: si:grafana
                  - title: Prometheus
                    url: https://prometheus.sarma.love
                    check-url: http://monitoring-kube-prometheus-prometheus.monitoring.svc.cluster.local:9090
                    icon: si:prometheus

          - type: monitor
            collapse-after: 10
            cache: 1m
            title: Infrastructure
            sites:
              - title: Longhorn
                url: https://longhorn.sarma.love
                check-url: http://longhorn-frontend.longhorn-system.svc.cluster.local
                icon: si:kubernetes
              - title: Vaultwarden
                url: https://vault.sarma.love
                check-url: http://vaultwarden-vaultwarden.vaultwarden.svc.cluster.local
                icon: si:bitwarden

      # Column 3: Right sidebar (small)
      - size: small
        widgets:
          - type: weather
            location: Belgrade, Serbia
            units: metric
            hour-format: 24h
            hide-location: false
            show-area-name: true
            cache: 30m

          - type: custom-api
            title: Headscale Nodes
            title-url: https://headplane.sarma.love/admin
            url: https://headscale.sarma.love/api/v1/node
            cache: 30s
            headers:
              Authorization: Bearer ${HEADSCALE_API_KEY}
            template: |
              {{/* Headscale Nodes Widget - Adapted from Tailscale widget */}}
              {{/* CSS source: widgets/headscale-nodes/style.css */}}
              {{/* Set to true if you'd like an indicator for online devices */}}
              {{ $enableOnlineIndicator := true }}

              <style>
              .device-info-container {
                position: relative;
                overflow: hidden;
                height: 1.5em;
              }
              .device-info {
                display: flex;
                transition: transform 0.2s ease, opacity 0.2s ease;
              }
              .device-ip {
                position: absolute;
                top: 0;
                left: 0;
                transform: translateY(-100%);
                opacity: 0;
                transition: transform 0.2s ease, opacity 0.2s ease;
              }
              .device-info-container:hover .device-info {
                transform: translateY(100%);
                opacity: 0;
              }
              .device-info-container:hover .device-ip {
                transform: translateY(0);
                opacity: 1;
              }
              .router-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: var(--color-blue-light);
                display: inline-block;
                margin-left: 4px;
                vertical-align: middle;
              }
              .offline-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: var(--color-negative);
                display: inline-block;
                margin-left: 4px;
                vertical-align: middle;
              }
              .online-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: var(--color-positive);
                display: inline-block;
                margin-left: 4px;
                vertical-align: middle;
              }
              .device-name-container {
                display: flex;
                align-items: center;
                gap: 8px;
              }
              .indicators-container {
                display: flex;
                align-items: center;
                gap: 4px;
              }
              .tag-badge {
                background-color: var(--color-primary-dark);
                color: var(--color-text-base);
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 0.75em;
                font-weight: 500;
              }
              </style>

              <ul class="list list-gap-10 collapsible-container" data-collapse-after="4">
                {{ range .JSON.Array "nodes" }}
                <li>
                  <div class="flex items-center gap-10">
                    <div class="device-name-container grow">
                      <span class="size-h4 block text-truncate color-primary">
                        {{ .String "givenName" }}
                      </span>
                      <div class="indicators-container">
                        {{ $online := .Bool "online" }}
                        {{ if $online }}
                          {{ if $enableOnlineIndicator }}
                          <span class="online-indicator" data-popover-type="text" data-popover-text="Online"></span>
                          {{ end }}
                        {{ else }}
                          {{ $lastSeen := .String "lastSeen" | parseTime "rfc3339" }}
                          {{ $lastSeenTimezoned := $lastSeen.In now.Location }}
                          <span class="offline-indicator" data-popover-type="text"
                            data-popover-text="Offline - Last seen {{ $lastSeenTimezoned.Format "Jan 2 3:04pm" }}"></span>
                        {{ end }}

                        {{/* Show router indicator if node has approved routes */}}
                        {{ $routes := .Array "approvedRoutes" }}
                        {{ if gt (len $routes) 0 }}
                        <span class="router-indicator" data-popover-type="text"
                          data-popover-text="Router - {{ range $i, $route := $routes }}{{ if $i }}, {{ end }}{{ $route }}{{ end }}"></span>
                        {{ end }}
                      </div>
                    </div>
                    {{/* Show tags if present */}}
                    {{ $tags := .Array "validTags" }}
                    {{ if gt (len $tags) 0 }}
                    <div class="flex gap-5">
                      {{ range $tags }}
                      {{ $tagValue := .Str }}
                      <span class="tag-badge">{{ $tagValue | trimPrefix "tag:" }}</span>
                      {{ end }}
                    </div>
                    {{ end }}
                  </div>
                  <div class="device-info-container">
                    <ul class="list-horizontal-text device-info">
                      <li>{{ .String "user.name" }}</li>
                    </ul>
                    <div class="device-ip">
                      {{ .String "ipAddresses.0" }}
                    </div>
                  </div>
                </li>
                {{ end }}
              </ul>

          - type: extension
            url: http://glance-k8s-glance-k8s.glance-k8s.svc.cluster.local/extension/nodes
            allow-potentially-dangerous-html: true
            cache: 10s

  - name: Media
    columns:
      - size: full
        widgets:
          - type: split-column
            widgets:
              - type: monitor
                cache: 1m
                title: Download & Indexing
                sites:
                  - title: qBittorrent
                    url: https://qbittorrent.sarma.love
                    check-url: http://qbittorrent.media.svc.cluster.local:8080
                    icon: si:qbittorrent
                  - title: Prowlarr
                    url: https://prowlarr.sarma.love
                    check-url: http://prowlarr.media.svc.cluster.local:9696
                    icon: mdi:download-network

              - type: monitor
                cache: 1m
                title: Streaming & Requests
                sites:
                  - title: Jellyfin
                    url: https://jellyfin.sarma.love
                    check-url: http://jellyfin.media.svc.cluster.local:8096
                    icon: si:jellyfin
                  - title: Jellyseerr
                    url: https://jellyseerr.sarma.love
                    check-url: http://jellyseerr.media.svc.cluster.local:5055
                    icon: si:jellyfin

      - size: full
        widgets:
          - type: split-column
            widgets:
              - type: monitor
                cache: 1m
                title: Automation
                sites:
                  - title: Sonarr
                    url: https://sonarr.sarma.love
                    check-url: http://sonarr.media.svc.cluster.local:8989
                    icon: si:sonarr
                  - title: Radarr
                    url: https://radarr.sarma.love
                    check-url: http://radarr.media.svc.cluster.local:7878
                    icon: si:radarr
                  - title: Bazarr
                    url: https://bazarr.sarma.love
                    check-url: http://bazarr.media.svc.cluster.local:6767
                    icon: mdi:closed-caption

              - type: monitor
                cache: 1m
                title: Monitoring
                sites:
                  - title: Jellystat
                    url: https://jellystat.sarma.love
                    check-url: http://jellystat.media.svc.cluster.local:3000
                    icon: mdi:chart-line

          # Jellyfin Library Stats
          - type: custom-api
            title: Library Stats
            title-url: https://jellyfin.sarma.love
            cache: 1h
            url: http://jellyfin:8096/emby/Items/Counts
            headers:
              X-Emby-Token: ${JELLYFIN_API_KEY}
            template: |
              {{ if not .JSON }}
                <div class="error">Error: Unable to fetch library statistics</div>
              {{ else }}
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                  <div style="text-align: center; padding: 10px;">
                    <div style="font-size: 2em; font-weight: bold; color: var(--color-primary);">
                      {{ .JSON.Get "MovieCount" }}
                    </div>
                    <div style="color: var(--color-text-base);">Movies</div>
                  </div>
                  <div style="text-align: center; padding: 10px;">
                    <div style="font-size: 2em; font-weight: bold; color: var(--color-primary);">
                      {{ .JSON.Get "SeriesCount" }}
                    </div>
                    <div style="color: var(--color-text-base);">Shows</div>
                  </div>
                  <div style="text-align: center; padding: 10px;">
                    <div style="font-size: 2em; font-weight: bold; color: var(--color-primary);">
                      {{ .JSON.Get "EpisodeCount" }}
                    </div>
                    <div style="color: var(--color-text-base);">Episodes</div>
                  </div>
                  <div style="text-align: center; padding: 10px;">
                    <div style="font-size: 2em; font-weight: bold; color: var(--color-primary);">
                      {{ .JSON.Get "SongCount" }}
                    </div>
                    <div style="color: var(--color-text-base);">Songs</div>
                  </div>
                </div>
              {{ end }}

          # Jellyseerr Request Stats
          - type: custom-api
            title: Media Requests
            title-url: https://jellyseerr.sarma.love
            cache: 1h
            url: http://jellyseerr:5055/api/v1/request/count
            headers:
              accept: application/json
              X-Api-Key: ${JELLYSEERR_API_KEY}
            template: |
              {{ if not .JSON }}
                <div class="error">Unable to fetch request statistics</div>
              {{ else }}
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                  <div style="padding: 8px; text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--color-warning);">
                      {{ .JSON.Get "pending" }}
                    </div>
                    <div style="font-size: 0.85em;">Pending</div>
                  </div>
                  <div style="padding: 8px; text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--color-positive);">
                      {{ .JSON.Get "approved" }}
                    </div>
                    <div style="font-size: 0.85em;">Approved</div>
                  </div>
                  <div style="padding: 8px; text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--color-primary);">
                      {{ .JSON.Get "processing" }}
                    </div>
                    <div style="font-size: 0.85em;">Processing</div>
                  </div>
                  <div style="padding: 8px; text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--color-text-highlight);">
                      {{ .JSON.Get "available" }}
                    </div>
                    <div style="font-size: 0.85em;">Available</div>
                  </div>
                </div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--color-separator); text-align: center;">
                  <span style="font-size: 0.9em; color: var(--color-text-base);">
                    Total: {{ .JSON.Get "total" }} requests
                    ({{ .JSON.Get "movie" }} movies, {{ .JSON.Get "tv" }} shows)
                  </span>
                </div>
              {{ end }}

          # qBittorrent Stats
          - type: custom-api
            title: qBittorrent
            title-url: https://qbittorrent.sarma.love
            cache: 10s
            subrequests:
              transfer:
                url: http://qbittorrent:8080/api/v2/transfer/info
              seeding:
                url: http://qbittorrent:8080/api/v2/torrents/info?filter=seeding
              leeching:
                url: http://qbittorrent:8080/api/v2/torrents/info?filter=downloading
            template: |
              {{ $transfer := .Subrequests.transfer.JSON }}
              {{ $seeding := .Subrequests.seeding.JSON }}
              {{ $leeching := .Subrequests.leeching.JSON }}

              {{ if not $transfer }}
                <div class="error">Unable to connect to qBittorrent</div>
              {{ else }}
                <div style="display: flex; flex-direction: column; gap: 10px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--color-text-base);">Download:</span>
                    <span style="font-weight: bold; color: var(--color-positive);">
                      {{ if gt ($transfer.Get "dl_info_speed").Int 0 }}
                        {{ divf ($transfer.Get "dl_info_speed").Float 1048576 | printf "%.1f" }} MB/s
                      {{ else }}
                        0 MB/s
                      {{ end }}
                    </span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--color-text-base);">Upload:</span>
                    <span style="font-weight: bold; color: var(--color-warning);">
                      {{ if gt ($transfer.Get "up_info_speed").Int 0 }}
                        {{ divf ($transfer.Get "up_info_speed").Float 1048576 | printf "%.1f" }} MB/s
                      {{ else }}
                        0 MB/s
                      {{ end }}
                    </span>
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; padding-top: 10px; border-top: 1px solid var(--color-separator);">
                    <div style="text-align: center;">
                      <div style="font-size: 1.5em; font-weight: bold; color: var(--color-primary);">
                        {{ len $seeding.Array }}
                      </div>
                      <div style="font-size: 0.85em;">Seeding</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 1.5em; font-weight: bold; color: var(--color-positive);">
                        {{ len $leeching.Array }}
                      </div>
                      <div style="font-size: 0.85em;">Downloading</div>
                    </div>
                  </div>
                </div>
              {{ end }}
